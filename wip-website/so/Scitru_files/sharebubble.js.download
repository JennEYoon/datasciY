function center(thing) {
    thing.css("position","absolute");
    thing.css("top", ( $(window).height() - thing.height() ) / 3+$(window).scrollTop() + "px");
    thing.css("left", ( $(window).width() - thing.width() ) / 2+$(window).scrollLeft() + "px");
    return thing;
}

$(document).ready(function(){
    var mouse_is_inside = false;
    $('.bubble').draggable();
    $('.bubble, #shareButton, #newConnectomeButton').hover(function(){mouse_is_inside=true; }, 
                                                                function(){mouse_is_inside=false;});
    $("body").click(function(){
        if(! mouse_is_inside) {
            $('.bubble').hide();
            $('#everything').fadeTo("medium", 1);
        }
    });
    $('#shareButton').click(function(){
        $('.bubble').show();
        getShareBubble();
        $('#everything').fadeTo("slow", 0.55);
    });
    

});



function getShareBubble(){
    var a=document.URL.split('/');
    var hex_id=a[a.indexOf('articles')+1];

        $.post("/ajax/share/shareBubble/", {hex_id: hex_id }, function(data){
            $('.bubble').html(data);
            setup_shareduser();
            $("#shareForm .searchfield").keyup(function(event){
                if(event.keyCode == 13){ // When the enter key is pressed, submit the search form
                    $("#shareForm").submit();
                }
            });
            center($('.bubble'));
            $('#privacy').click(function() {
                $.post("/ajax/switcharticleprivacy/", { hex_id: hex_id}, function(data) { getShareBubble()});});
            $('#shareNotification').hide();
            
            $('#shareForm').submit(function(){
                var friend_id=$('#shareField').val();
                $.post(
                    "/ajax/share/share/",
                    {friend_id: friend_id, hex_id: hex_id},
                    function(data){
                        if(data=='');
                        else{
                            clearTimeout(t);
                            if(data=='0'){ notify('#shareNotification',' This user can already see the article');}
                            else if(data=='1') {notify('#shareNotification',' This user does not exist.');}
                            else if(data=='2') {notify('#shareNotification'," You can't share this article because you aren't the author.");}
                            else{
                                notify('#shareNotification',' '+data+' can now see this article.')
                                $('#sharedfriends').append("<span class='shareduser tag'><a href='/authors/"+friend_id+"/' friend_id='"+friend_id+"'>"+data+" </a></span>");
                                $('#onlyYou').hide();
                            }
                            
                            
                            
                            setup_shareduser();
                        }
                    },
                    "text");
                return false; });

        
        }, "text");
}

function setup_shareduser(){
             $('.shareduser').unbind('mouseenter mouseleave');
             $('.shareduser').hover(
                function(){
                    $(this).prepend("<img id='unshare' src=/support/images/x2.gif />");
                    $(this).find('#unshare').click(function(){
                        var shareduser=$(this).parent();
                        var friend_name=$(this).siblings().text();
                        var friend_id=$(this).siblings().attr('friend_id');
                        var a=document.URL.split('/');
                        var hex_id=a[a.indexOf('articles')+1];
                        $.post(     "/ajax/share/unshare",
                                        {friend_id: friend_id, hex_id: hex_id}, 
                                        function(data){
                                            if(data='0'){
                                                clearTimeout(t);
                                                shareduser.remove();
                                                notify('#shareNotification',friend_name +' can no longer access this article.');
                                                
                                            }   
                                        },
                                        "text");
                    });
                   
                },
                function(){
                    $(this).children('img').remove();
                });   
}